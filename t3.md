# Tema 3. ASP.NET MVC 5  

## Acciones de los controladores. Tipos y parámetros. 

### Creating a Controller with IController

Para ello debemos crear una clase que implemente la interfaz IController:

```csharp
public interface IController {
    void Execute(RequestContext requestContext);
}
```

Código de BasicController que implementa la interfaz IController:
```csharp
 public class BasicController : IController {

     public void Execute(RequestContext requestContext) {
        // Obtenemos el nombre del controlador y de la acción, por ejemplo, Home y Index
         string controller = (string)requestContext.RouteData.Values["controller"];
         string action = (string)requestContext.RouteData.Values["action"];
        // Su la acción es "redirect" redirigimos a la acción Index del controlador Derived
         if (action.ToLower() == "redirect") {
             requestContext.HttpContext.Response.Redirect("/Derived/Index");
         } else {
            // Si no, escribimos en la respuesta el nombre del controlador y de la acción
             requestContext.HttpContext.Response.Write(
                 string.Format("Controller: {0}, Action: {1}",
                 controller, action));
         }
     }
 }

```
Las propiedades de la clase RequestContext:
- HttpContext: Returns an HttpContextBase object that describes the current request
- RouteData: Returns a RouteData object that describes the route that matched the request:
  - Route: Returns the RouteBase implementation that matched the route
  - RouteHandler: Returns the IRouteHandler that handled the route
  - Values: Returns a collection of segment values, indexed by name

### Creating a Controller by Deriving from the Controller Class

```csharp
 public class DerivedController : Controller {

     public ActionResult Index() {
         ViewBag.Message = "Hello from the DerivedController Index method";
         return View("MyView");
     }

     public ActionResult ProduceOutput() {
         return Redirect("/Basic/Index");
     } 


 }
```

### Receiving Request Data
There are three main ways to access that data:
- **Extract it from a set of context objects:**

| Property                    | Type                        | Description                                                                       |
|-----------------------------|-----------------------------|-----------------------------------------------------------------------------------|
| Request.QueryString          | NameValueCollection         | GET variables sent with this request                                              |
| Request.Form                 | NameValueCollection         | POST variables sent with this request                                             |
| Request.Cookies              | HttpCookieCollection        | Cookies sent by the browser with this request                                     |
| Request.HttpMethod           | string                      | The HTTP method (verb, such as GET or POST) used for this request                 |
| Request.Headers              | NameValueCollection         | The full set of HTTP headers sent with this request                               |
| Request.Url                  | Uri                         | The URL requested                                                                 |
| Request.UserHostAddress       | string                      | The IP address of the user making this request                                    |
| RouteData.Route              | RouteBase                   | The chosen RouteTable.Routes entry for this request                               |
| RouteData.Values             | RouteValueDictionary        | Active route parameters (either extracted from the URL or default values)         |
| HttpContext.Application       | HttpApplicationStateBase    | Application state store                                                          |
| HttpContext.Cache            | Cache                       | Application cache store                                                          |
| HttpContext.Items            | IDictionary                 | State store for the current request                                               |
| HttpContext.Session          | HttpSessionStateBase        | State store for the visitor’s session                                             |
| User                         | IPrincipal                  | Authentication information about the logged-in user                               |
| TempData                     | TempDataDictionary          | Temporary data items stored for the current user                                  |
  


- **Have the data passed as parameters to your action method:**
```csharp
// parameters names are case-insensitive
public ActionResult ReceiveForm(string name, string city) {

    ViewBag.Name = name;
    ViewBag.City = city;
    return View();
}
```
**Value-type parameters are compulsory.** To make them optional, either specify a default value  or change the parameter type to a nullable type (such as int? or DateTime?), so the MVC Framework can pass null if no value is available.

**Reference-type parameters are optional**. To make them compulsory (to ensure that a non-null value is passed), add some code to the top of the action method to reject null values. For example, if the value equals null, throw an ArgumentNullException.


Specifying Default Parameter Values

```csharp
public ActionResult Search(string query= "all", int page = 1) {
    // si para page se le paso un valor no numérico, se le asigna el valor 1, pero no se lanza una excepción
    // ...process request...
    return View();
}
```

- Explicitly invoke the framework’s model binding feature.
```csharp
public ActionResult MyAction(MyModel model)
{
    // ASP.NET realiza el model binding automáticamente
    return View(model);
}
```

### Producing Output
Podemos usar:
En IController:
- requestContext.HttpContext.Response.Write("salida") para escribir directamente en la respuesta.
- requestContext.HttpContext.Response.Redirect("/Derived/Index") para redirigir a otra acción.
En Controller:
- return View("MyView") para devolver una vista.
- return Redirect("/Basic/Index") para redirigir a otra acción.
- return Content("Hello World") para devolver un texto.
  
#### Action results

The MVC Framework contains a number of built-in action result types. All of these types are derived from ActionResult, and many of them have convenient helper methods in the Controller class:

| Type                     | Description                                                                                                                                                                 | Helper Methods                         |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------|
| ViewResult                | Renders the specified or default view template                                                                                                                              | View                                   |
| PartialViewResult         | Renders the specified or default partial view template                                                                                                                      | PartialView                            |
| RedirectToRouteResult     | Issues an HTTP 301 or 302 redirection to an action method or specific route entry, generating a URL according to your routing configuration                                  | RedirectToAction, RedirectToRoute      |
| RedirectResult            | Issues an HTTP 301 or 302 redirection to a specific URL                                                                                                                     | Redirect, RedirectPermanent            |
| ContentResult             | Returns raw textual data to the browser, optionally setting a content-type header                                                                                           | Content                                |
| FileResult                | Transmits binary data (such as a file from disk or a byte array in memory) directly to the browser                                                                           | File                                   |
| JsonResult                | Serializes a .NET object in JSON format and sends it as the response.                                                                                                        | Json                                   |
| JavaScriptResult          | Sends a snippet of JavaScript source code that should be executed by the browser                                                                                            | JavaScript                             |
| HttpUnauthorizedResult    | Sets the response HTTP status code to 401 (meaning “not authorized”), which causes the active authentication mechanism to ask the visitor to log in                          | None                                   |
| HttpNotFoundResult        | Returns a HTTP 404—Not found error                                                                                                                                          | HttpNotFound                           |
| HttpStatusCodeResult      | Returns a specified HTTP code                                                                                                                                               | None                                   |
| EmptyResult               | Does nothing                                                                                                                                                                | None                                   |


#### Returning a View

Cuando hago return View("ViewName") el MVC Framework busca la vista ViewName en:

- /Views/<ControllerName>/<ViewName>.aspx
- /Views/<ControllerName>/<ViewName>.ascx
- /Views/Shared/<ViewName>.aspx
- /Views/Shared/<ViewName>.ascx
- /Views/<ControllerName>/<ViewName>.cshtml
- /Views/<ControllerName>/<ViewName>.vbhtml
- /Views/Shared/<ViewName>.cshtml
- /Views/Shared/<ViewName>.vbhtml

Si no especifico el nombre de la vista, el MVC Framework busca una vista con el mismo nombre que la acción.

Podemos especificar un layaout que usa la vista:
```csharp
public ViewResult Index() {
    return View("Index", "_AlternateLayoutPage");
}
```

Podemos especificar la ruta de la vista:
```csharp
public ViewResult Index() {
    return View("~/Views/Other/Index.cshtml");
}
```

#### Pasando datos a la vista
Dos formas:
- Pasando un modelo a la vista.
```csharp
public ViewResult Index() {
    return View(new MyModel());
}
```

En la vista lo usamos con @Model.NombrePropiedad:
```html
@model MyModel
<p>@Model.NombrePropiedad</p>
```

- ViewBag: un diccionario dinámico que permite pasar datos a la vista.

```csharp
public ViewResult Index() {
    ViewBag.Message = "Hello from the controller";
    return View();
}
```

En la vista lo usamos con @ViewBag.NombrePropiedad:
```html
<p>@ViewBag.Message</p>
```

#### Redirecciones
Podemos hacer redireccions temporales (302) o permanentes (301) con Redirect y RedirectPermanent.
- Redirect: redirige a una URL.
```csharp
// temporal
public ActionResult Redirect() {
    return Redirect("/Basic/Index");
}
// permanente
public ActionResult RedirectPermanent() {
    return RedirectPermanent("/Basic/Index");
}

```
- Redirecting to a Routing System URL
Podemos especificar la ruta mediante el sistema de rutas:
```csharp
public ActionResult RedirectToRoute() {
    return RedirectToRoute(new {
        controller = "Basic",
        action = "Index",
        id = "MyID"
    });
}
```
Para permanente usamos RedirectToRoutePermanent.
- Redirecting to an Action Method

```csharp
// Para una accción del mismo controlador
public ActionResult RedirectToAction() {
    return RedirectToAction("Index");
}
// Para una acción de otro controlador, por ejemplo Derived
public ActionResult RedirectToAction() {
    return RedirectToAction("Index", "Derived");
}
```
Para permanente usamos RedirectToActionPermanent.
Una redirección genera una nueva perticion HTTP, por lo que no se puede pasar datos a la acción redirigida. Si queremos pasar datos, usamos TempData:

```csharp
 public RedirectToRouteResult RedirectToRoute() {
        TempData["Message"] = "Hello";
        TempData["Date"] = DateTime.Now;
        return RedirectToAction("Index");
    }
```
Para recuperar los datos en la acción redirigida:
```csharp
public ActionResult Index() {
    ViewBag.Message = TempData["Message"];
    ViewBag.Date = TempData["Date"];
    return View();
}
```
Otra opción es acceder a TempData directamente desde la vista:
```html
<p>@TempData["Message"]</p>
<p>@TempData["Date"]</p>
```

#### Returning Errors and HTTP Codes

Podemos devolver un código de error HTTP con HttpStatusCodeResult:
```csharp
public HttpStatusCodeResult StatusCode() {
    return new HttpStatusCodeResult(404, "URL cannot be serviced");
}
```
Para devolver un error 404, también podemos usar HttpNotFound:
```csharp
public HttpNotFoundResult NotFound() {
    return HttpNotFound();
}
```
Para devolver un 401 (Unauthorized) usamos HttpUnauthorized:
```csharp
public HttpUnauthorizedResult Unauthorized() {
    // tenemos que crear una instancia de HttpUnauthorizedResult, porque no tiene helper
    return new HttpUnauthorizedResult();
}
```


## Validación de los modelos.

En **ASP.NET MVC 5**, el **ModelState** es una parte integral del proceso de validación de modelos. Se utiliza para mantener información sobre la validez del modelo y cualquier error de validación que ocurra durante la vinculación de datos de la vista a los controladores.

Cuando un usuario envía un formulario, ASP.NET MVC intenta asociar los datos del formulario a un modelo, y al hacerlo, verifica automáticamente si los datos son válidos según las reglas de validación establecidas en el modelo (como las anotaciones de datos, `DataAnnotations`). El **`ModelState`** se utiliza para verificar el resultado de esta validación y mostrar los mensajes de error apropiados en la vista si es necesario.

### Cómo funciona ModelState en la validación

1. **Model Binding**: Cuando los datos del formulario se envían al controlador, el framework asocia (binds) los datos del formulario a un modelo en la acción del controlador.
2. **Validación Automática**: Durante este proceso de binding, ASP.NET MVC valida automáticamente los datos enviados, en base a las reglas de validación que se definieron en el modelo.
3. **ModelState**: El resultado de este proceso de validación se almacena en el **`ModelState`**, que contiene un diccionario de valores y errores.

### Uso de `ModelState.IsValid`

El **`ModelState.IsValid`** es una propiedad booleana que indica si los datos del modelo pasaron todas las reglas de validación. Si los datos no cumplen con las reglas, `ModelState.IsValid` devolverá `false`, y los errores estarán disponibles en `ModelState`.

### Ejemplo paso a paso:

#### Paso 1: Definir el Modelo con Validaciones

Primero, se define un modelo con reglas de validación usando **DataAnnotations** (anotaciones de datos) como `[Required]`, `[StringLength]`, etc.

```csharp
public class UsuarioViewModel
{
    [Required(ErrorMessage = "El nombre es obligatorio.")]
    public string Nombre { get; set; }

    [Required(ErrorMessage = "El correo es obligatorio.")]
    [EmailAddress(ErrorMessage = "Formato de correo inválido.")]
    public string Correo { get; set; }

    [Range(18, 99, ErrorMessage = "La edad debe estar entre 18 y 99 años.")]
    public int Edad { get; set; }
}
```
The Built-in Validation Attributes:
| Attribute           | Example                          | Description                                                                                                                                                        |
|---------------------|----------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Compare             | `[Compare("MyOtherProperty")]`   | Two properties must have the same value. Useful when asking the user to provide the same information twice, such as an email address or password.                   |
| Range               | `[Range(10, 20)]`                | A numeric value (or any property type that implements `IComparable`) must lie within the specified minimum and maximum values.                                      |
| RegularExpression   | `[RegularExpression("pattern")]` | A string value must match the specified regular expression pattern. By default, matches are case-sensitive, but can be case-insensitive with the `(?i)` modifier.   |
| Required            | `[Required]`                     | The value must not be empty or a string consisting only of spaces. Use `[Required(AllowEmptyStrings = true)]` to treat whitespace as valid.                         |
| StringLength        | `[StringLength(10)]`             | A string value must not exceed the specified maximum length. You can also specify a minimum length using `[StringLength(10, MinimumLength=2)]`.                     |


#### Paso 2: Acción del Controlador que Recibe el Formulario

En la acción del controlador, puedes utilizar el **`ModelState`** para comprobar si los datos enviados son válidos antes de proceder con la lógica de negocio (como guardar en la base de datos).

```csharp
public class UsuarioController : Controller
{
    [HttpPost]
    public ActionResult Crear(UsuarioViewModel modelo)
    {
        if (ModelState.IsValid) // Verificar si el modelo es válido
        {
            // Aquí va la lógica para guardar los datos en la base de datos, etc.
            return RedirectToAction("Exito");
        }

        // Si el modelo no es válido, vuelve a la vista con los errores
        return View(modelo);
    }
}
```

Alternativamente, podemos hacer una validación manual:
```csharp
public class UsuarioController : Controller
{
    [HttpPost]
    public ActionResult Crear(UsuarioViewModel modelo)
    {
        // Validación manual del campo "Nombre"
        if (string.IsNullOrEmpty(modelo.Nombre))
        {
            ModelState.AddModelError("Nombre", "El nombre es obligatorio.");
        }
        else if (modelo.Nombre.Length < 3)
        {
            ModelState.AddModelError("Nombre", "El nombre debe tener al menos 3 caracteres.");
        }

        // Validación manual del campo "Correo"
        if (string.IsNullOrEmpty(modelo.Correo))
        {
            ModelState.AddModelError("Correo", "El correo es obligatorio.");
        }
        else if (!modelo.Correo.Contains("@"))
        {
            ModelState.AddModelError("Correo", "Formato de correo inválido.");
        }

        // Validación manual del campo "Edad"
        if (modelo.Edad < 18 || modelo.Edad > 99)
        {
            ModelState.AddModelError("Edad", "La edad debe estar entre 18 y 99 años.");
        }

        // Si el ModelState no es válido (si hay errores), volver a la vista con los mensajes de error
        if (!ModelState.IsValid)
        {
            return View(modelo); // Vuelve a mostrar la vista con los errores
        }

        // Si no hay errores, proceder con la lógica de negocio (guardar en la base de datos, etc.)
        return RedirectToAction("Exito");
    }
}

```

- **`ModelState.IsValid`**: Si todas las reglas de validación se cumplen, `ModelState.IsValid` será `true`. Si alguna regla falla, será `false` y se mostrarán los errores correspondientes.

#### Paso 3: Mostrar los Errores en la Vista

En la vista, puedes usar **`Html.ValidationMessageFor`** y **`Html.ValidationSummary`** para mostrar los mensajes de error de validación al usuario.

```csharp
@model Proyecto.Models.UsuarioViewModel

@using (Html.BeginForm("Crear", "Usuario", FormMethod.Post))
{
    <div>
        @Html.LabelFor(m => m.Nombre)
        @Html.TextBoxFor(m => m.Nombre)
        @Html.ValidationMessageFor(m => m.Nombre) <!-- Mensaje de error específico -->
    </div>

    <div>
        @Html.LabelFor(m => m.Correo)
        @Html.TextBoxFor(m => m.Correo)
        @Html.ValidationMessageFor(m => m.Correo) <!-- Mensaje de error específico -->
    </div>

    <div>
        @Html.LabelFor(m => m.Edad)
        @Html.TextBoxFor(m => m.Edad)
        @Html.ValidationMessageFor(m => m.Edad) <!-- Mensaje de error específico -->
    </div>

    <div>
        <input type="submit" value="Enviar" />
    </div>

    @Html.ValidationSummary(true) <!-- Muestra un resumen general de errores -->
}
```

- **`@Html.ValidationMessageFor()`**: Muestra el mensaje de error específico para un campo si la validación falla.
- **`@Html.ValidationSummary()`**: Muestra todos los errores de validación en un solo bloque (generalmente en la parte superior del formulario).

### Ejemplo Completo:

1. **Modelo con validaciones**:

   ```csharp
   public class UsuarioViewModel
   {
       [Required(ErrorMessage = "El nombre es obligatorio.")]
       public string Nombre { get; set; }

       [Required(ErrorMessage = "El correo es obligatorio.")]
       [EmailAddress(ErrorMessage = "Formato de correo inválido.")]
       public string Correo { get; set; }

       [Range(18, 99, ErrorMessage = "La edad debe estar entre 18 y 99 años.")]
       public int Edad { get; set; }
   }
   ```

2. **Acción del controlador**:

   ```csharp
   [HttpPost]
   public ActionResult Crear(UsuarioViewModel modelo)
   {
       if (ModelState.IsValid)
       {
           // Guardar en base de datos, lógica de negocio, etc.
           return RedirectToAction("Exito");
       }

       // Si hay errores de validación, vuelve a la vista con el modelo
       return View(modelo);
   }
   ```

3. **Vista del formulario**:

   ```html
   @model Proyecto.Models.UsuarioViewModel

   @using (Html.BeginForm("Crear", "Usuario", FormMethod.Post))
   {
       <div>
           @Html.LabelFor(m => m.Nombre)
           @Html.TextBoxFor(m => m.Nombre)
           @Html.ValidationMessageFor(m => m.Nombre)
       </div>

       <div>
           @Html.LabelFor(m => m.Correo)
           @Html.TextBoxFor(m => m.Correo)
           @Html.ValidationMessageFor(m => m.Correo)
       </div>

       <div>
           @Html.LabelFor(m => m.Edad)
           @Html.TextBoxFor(m => m.Edad)
           @Html.ValidationMessageFor(m => m.Edad)
       </div>

       <div>
           <input type="submit" value="Enviar" />
       </div>

       @Html.ValidationSummary(true)
   }
   ```

### Validaciones Personalizadas

Además de las validaciones automáticas con anotaciones de datos, puedes agregar validaciones personalizadas directamente en el controlador:

```csharp
if (modelo.Nombre == "Prohibido")
{
    ModelState.AddModelError("Nombre", "Este nombre está prohibido.");
}
```



## Sintaxis de las vistas. 

Podemos añadir contenido dinámico de las siguientes maneras:
- Inline code blocks
- HTML helpers methods
- Sections
- Partial views
- Child actions

### Using Layout Sections
En ASP.NET MVC y Razor Pages, `@section` y `@RenderSection` son herramientas usadas para definir y renderizar contenido seccional en las vistas, permitiendo organizar la estructura de las páginas y reutilizar layouts de manera eficiente.

#### Uso de `@section` y `@RenderSection`

1. **Layout en ASP.NET**:
   Un **layout** es una vista principal o plantilla que define la estructura común para varias páginas de una aplicación, como cabeceras, pies de página, menús, etc. Luego, cada vista individual puede tener su propio contenido específico que se inserta en el layout.

2. **@section**:
   El bloque `@section` permite que las vistas hijas (que usan un layout) definan contenido específico para una sección nombrada del layout. Sirve para insertar contenido adicional en áreas específicas del layout sin alterar su estructura principal.

   #### Sintaxis:
   ```csharp
   @section NombreDeLaSeccion {
       <p>Contenido específico de esta sección.</p>
   }
   ```

3. **@RenderSection**:
   Este es el método que se usa en el layout para "renderizar" (mostrar) el contenido definido en una sección por las vistas que lo utilicen. Se coloca en el layout y busca el contenido de la sección correspondiente.

   #### Sintaxis:
   ```csharp
   @RenderSection("NombreDeLaSeccion", required: false)
   ```

   - **`"NombreDeLaSeccion"`**: Es el nombre de la sección que debe renderizarse.
   - **`required: false`**: Indica si la sección es obligatoria o no. Si es `true`, se espera que cada vista que use este layout defina la sección. Si es `false`, no es obligatorio.

#### Ejemplo de Uso

1. **Layout (por ejemplo, `_Layout.cshtml`)**:
   El layout podría tener una estructura general y secciones opcionales para contenido dinámico.

```html
<!DOCTYPE html>
<html>
<head>
    <title>@ViewBag.Title - Mi Aplicación</title>
</head>
<body>
    <header>
        <h1>Cabecera Común</h1>
    </header>

    <div class="container">
        <!-- Aquí se inserta el contenido principal de las vistas -->
        <!-- si no incluimos @RenderBody, el contenido principal de la vista no se renderiza-->
        @RenderBody()  
    </div>

    <footer>
    <!-- Sección opcional para el pie de página -->
        @if (IsSectionDefined("Footer")) {
            @RenderSection("Footer", required: false)
        } else {
            <h4>This is the default footer</h4>
        }
        <!-- Sección obligatoria para scripts, si no la metemos en la vista, da error -->
        @RenderSection("scripts") 
    </footer>
</body>
</html>
```

2. **Vista específica (por ejemplo, `Index.cshtml`)**:
   Una vista que utiliza el layout anterior puede definir contenido específico en una sección.

   ```csharp
   @{
       Layout = "~/Views/Shared/_Layout.cshtml";  // Usar el layout
       ViewBag.Title = "Página Principal";
   }

   <h2>Bienvenido a la página principal</h2>

   @section scripts {
       <script>
           console.log('Sección de scripts específicos para esta vista.');
       </script>
   }
   ```


#### Flujo de Trabajo:
1. El layout (`_Layout.cshtml`) renderiza el contenido común de la aplicación y llama a `@RenderBody()` para incluir el contenido principal de cada vista.
2. Si una vista define una sección (en este caso, `@section scripts`), esa sección será renderizada en el lugar donde se haya colocado `@RenderSection("scripts")` en el layout.
3. Si no se define una sección opcional y `required: false`, el layout seguirá funcionando sin errores.

### Using Partial Views

Las vistas parciales son fragmentos de vistas que se pueden reutilizar en múltiples vistas o en el mismo layout. Son útiles para separar y reutilizar partes de la interfaz de usuario que se repiten en diferentes páginas.

#### Creación de una Vista Parcial

1. **Crear una vista parcial**:
   - Crear un archivo `.cshtml` en la carpeta `Views/Shared` (por defecto busca en la carpeta de las vistas asociada al controlador y en Shared) o en una carpeta específica.
   - Podemos usar `@model` para definir el modelo de la vista parcial.
   - Definir el contenido de la vista parcial.

   ```csharp
   @model IEnumerable<Product>

   <h2>Lista de Productos</h2>
   <ul>
       @foreach (var product in Model) {
           <li>@product.Name - @product.Price</li>
       }
   </ul>
   ```

2. **Renderizar la vista parcial**:
   - Usar `Html.Partial` o `Html.RenderPartial` en una vista o en un layout para renderizar la vista parcial.

   ```csharp
   @Html.Partial("_ProductList", Model.Products)
   ```

#### Using Child Actions

Las acciones de hijo (child actions) son acciones de controlador que se pueden invocar desde una vista para generar contenido dinámico. A diferencia de las vistas parciales, las acciones de hijo se ejecutan en el servidor y pueden devolver cualquier tipo de resultado.

```csharp
using System;
using System.Web.Mvc;
namespace WorkingWithRazor.Controllers {
    public class HomeController : Controller {
        public ActionResult Index() {
            string[] names = { "Apple", "Orange", "Pear" };
            return View(names);
        }
        public ActionResult List() {
            return View();
        }
        // EL filtro ChildActionOnly evita que la acción sea invocada directamente por una petición HTTP, pero no es necesario para invocarla desde una vista
        [ChildActionOnly]
        public ActionResult Time() {
            // Normalmente, una acción de hijo devolverá una vista parcial, pero no es obligatorio
            return PartialView(DateTime.Now);
        }
    }
}   
```
Vista parcial Time.cshtml:
```csharp
@model DateTime
<p>La hora actual es: @Model.ToString("T")</p>
```
Podemos invoar la acción de hijo desde una vista con:
```csharp
@Html.Action("Time")
```
Si queremos llamar a la accion hija desde otro controlador, usamos:
```csharp
@Html.Action("Time", "ControladorDondeEstaLaAccionHija")
```

Podemos definir parámetros para la acción de hijo:
```csharp
[ChildActionOnly]
public ActionResult Time(DateTime time) {
    return PartialView(time);
}
```
Y llamarla desde la vista con:
```csharp
@Html.Action("Time", new { time = DateTime.Now })
```



## Seguridad en aplicaciones MVC 5. Uso de claves criptográficas, mecanismos de autenticación y control de sesiones.  


## Helpers

Los helpers son métodos que generan HTML y otros elementos de la interfaz de usuario. Los helpers de HTML son métodos que generan elementos HTML, como etiquetas de formulario, controles de entrada y otros elementos de la interfaz de usuario.

#### The Overloads of the BeginForm Helper Method

| Overload                                                 | Description                                                                                                                                                    |
|----------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `BeginForm()`                                             | Creates a form which posts back to the action method it originated from                                                                                         |
| `BeginForm(action, controller)`                          | Creates a form which posts back to the action method and controller, specified as strings                                                                       |
| `BeginForm(action, controller, method)`                  | As for the previous overload, but allows you to specify the value for the method attribute using a value from the `System.Web.Mvc.FormMethod` enumeration        |
| `BeginForm(action, controller, method, attributes)`       | As for the previous overload, but allows you to specify attributes for the form element using an object whose properties are used as the attribute names         |
| `BeginForm(action, controller, routeValues, method, attributes)` | As for the previous overload, but allows you to specify values for the variable route segments in your application routing configuration as an object whose properties correspond to the routing variables |


#### Basic Input HTML Helpers

| HTML Element    | Example                                                    | Output                                                                                                                                             |
|-----------------|------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------|
| Check box       | `Html.CheckBox("myCheckbox", false)`                        | `<input id="myCheckbox" name="myCheckbox" type="checkbox" value="true" />`<br>`<input name="myCheckbox" type="hidden" value="false" />`              |
| Hidden field    | `Html.Hidden("myHidden", "val")`                            | `<input id="myHidden" name="myHidden" type="hidden" value="val" />`                                                                                 |
| Radio button    | `Html.RadioButton("myRadiobutton", "val", true)`            | `<input checked="checked" id="myRadiobutton" name="myRadiobutton" type="radio" value="val" />`                                                      |
| Password        | `Html.Password("myPassword", "val")`                        | `<input id="myPassword" name="myPassword" type="password" value="val" />`                                                                           |
| Text area       | `Html.TextArea("myTextarea", "val", 5, 20, null)`           | `<textarea cols="20" id="myTextarea" name="myTextarea" rows="5">val</textarea>`                                                                     |
| Text box        | `Html.TextBox("myTextbox", "val")`                          | `<input id="myTextbox" name="myTextbox" type="text" value="val" />`                                                                                 |


#### versiones fuertemente tipadas de los helpers de entrada HTML junto con ejemplos y su salida correspondiente.

| HTML Element   | Example                                      | Output                                                                                                                             |
|----------------|----------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------|
| Check box      | `Html.CheckBoxFor(x => x.IsApproved)`         | `<input id="IsApproved" name="IsApproved" type="checkbox" value="true" />` <br> `<input name="IsApproved" type="hidden" value="false" />` |
| Hidden field   | `Html.HiddenFor(x => x.FirstName)`            | `<input id="FirstName" name="FirstName" type="hidden" value="" />`                                                                 |
| Radio button   | `Html.RadioButtonFor(x => x.IsApproved, "val")`| `<input id="IsApproved" name="IsApproved" type="radio" value="val" />`                                                             |
| Password       | `Html.PasswordFor(x => x.Password)`           | `<input id="Password" name="Password" type="password" />`                                                                          |
| Text area      | `Html.TextAreaFor(x => x.Bio, 5, 20, new{})`  | `<textarea cols="20" id="Bio" name="Bio" rows="5">Bio value</textarea>`                                                            |
| Text box       | `Html.TextBoxFor(x => x.FirstName)`           | `<input id="FirstName" name="FirstName" type="text" value="" />`                                                                   |

#### Ejemplos de helpers para elementos \<select\> (listas desplegables y selección múltiple) y sus salidas HTML correspondientes.

| HTML Element      | Example                                                            | Output                                                                                                                             |
|-------------------|--------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------|
| Drop-down list    | `Html.DropDownList("myList", new SelectList(new [] {"A", "B"}), "Choose")` | `<select id="myList" name="myList">` <br> `  <option value="">Choose</option>` <br> `  <option>A</option>` <br> `  <option>B</option>` <br> `</select>` |
| Drop-down list    | `Html.DropDownListFor(x => x.Gender, new SelectList(new [] {"M", "F"}))` | `<select id="Gender" name="Gender">` <br> `  <option>M</option>` <br> `  <option>F</option>` <br> `</select>`                       |
| Multiple-select   | `Html.ListBox("myList", new MultiSelectList(new [] {"A", "B"}))`   | `<select id="myList" multiple="multiple" name="myList">` <br> `  <option>A</option>` <br> `  <option>B</option>` <br> `</select>`   |
| Multiple-select   | `Html.ListBoxFor(x => x.Vals, new MultiSelectList(new [] {"A", "B"}))` | `<select id="Vals" multiple="multiple" name="Vals">` <br> `  <option>A</option>` <br> `  <option>B</option>` <br> `</select>`      |


#### HTML Helpers That Render Select Elements
| HTML Element         | Example                                                                  | Output                                                                                          |
|----------------------|--------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------|
| Drop-down list       | `Html.DropDownList("myList", new SelectList(new [] {"A", "B"}), "Choose")`| `<select id="myList" name="myList"> <option value="">Choose</option> <option>A</option> <option>B</option> </select>` |
| Drop-down list       | `Html.DropDownListFor(x => x.Gender, new SelectList(new [] {"M", "F"}))`  | `<select id="Gender" name="Gender"> <option>M</option> <option>F</option> </select>`            |
| Multiple-select      | `Html.ListBox("myList", new MultiSelectList(new [] {"A", "B"}))`          | `<select id="myList" multiple="multiple" name="myList"> <option>A</option> <option>B</option> </select>` |
| Multiple-select      | `Html.ListBoxFor(x => x.Vals, new MultiSelectList(new [] {"A", "B"}))`    | `<select id="Vals" multiple="multiple" name="Vals"> <option>A</option> <option>B</option> </select>` |

### Templated Helper methods

Los templated helper methods son una forma de generar HTML de forma automática a partir de un modelo de datos. Los templated helper methods son útiles cuando se necesita generar HTML de forma dinámica basado en un modelo de datos.

Se diferencias de los helpers en que los templated helpers generan HTML basado en el tipo de datos del modelo, mientras que los helpers generan HTML basado en el nombre de la propiedad del modelo, sin estar vinculado al tipo de datos.

The MVC Templated HTML Helpers

| Helper        | Example                              | Description                                                                                                                                         |
|---------------|--------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------|
| Display       | `Html.Display("FirstName")`          | Renders a read-only view of the specified model property, choosing an HTML element according to the property’s type and metadata                     |
| DisplayFor    | `Html.DisplayFor(x => x.FirstName)`  | Strongly typed version of the previous helper                                                                                                       |
| Editor        | `Html.Editor("FirstName")`           | Renders an editor for the specified model property, choosing an HTML element according to the property’s type and metadata                           |
| EditorFor     | `Html.EditorFor(x => x.FirstName)`   | Strongly typed version of the previous helper                                                                                                       |
| Label         | `Html.Label("FirstName")`            | Renders an HTML `<label>` element referring to the specified model property                                                                          |
| LabelFor      | `Html.LabelFor(x => x.FirstName)`    | Strongly typed version of the previous helper                                                                                                       |

MVC Framework also defines helpers that operate on the entire objects, a process known as scaffolding:

| Helper            | Example                      | Description                                                                                               |
|-------------------|------------------------------|-----------------------------------------------------------------------------------------------------------|
| DisplayForModel    | `Html.DisplayForModel()`      | Renders a read-only view of the entire model object                                                        |
| EditorForModel     | `Html.EditorForModel()`       | Renders editor elements for the entire model object                                                        |
| LabelForModel      | `Html.LabelForModel()`        | Renders an HTML `<label>` element referring to the entire model object      

Using Model Metadata
Podemos incluir metadatos en el modelo para personalizar la forma en que se generan los elementos HTML:

```csharp
namespace HelperMethods.Models {
    public class Person {
        // Muestra el atributo PersonId con su valor y un input oculto
        [HiddenInput]
        public int PersonId { get; set; }

        // No muestra el atributo (ni el label ni el valor) e incluye un input oculto
        [HiddenInput(DisplayValue = false)]
        public int PersonId { get; set; }

        // excluye totalmente el atributo
        [ScaffoldColumn(false)]
        public int PersonId { get; set; }

        // Podemos definir un label
        [Display(Name = "First Name")]
        public string FirstName { get; set; }

        // Podemos definir un tipo de dato (solo queremos la fecha, no la hora)
        [DataType(DataType.Date)]
        public DateTime BirthDate { get; set; }

        // Por defecto se usa el template asociado al tipo de datos, pero podemos especificar uno con UIHint
        [UIHint("MultilineText")]
        public string Description { get; set; }

}
```

The Values of the DataType Enumeration
| Value           | Description                                                                                     |
|-----------------|-------------------------------------------------------------------------------------------------|
| DateTime        | Displays a date and time (this is the default behavior for `System.DateTime` values)             |
| Date            | Displays the date portion of a `DateTime`                                                        |
| Time            | Displays the time portion of a `DateTime`                                                        |
| Text            | Displays a single line of text                                                                   |
| PhoneNumber     | Displays a phone number                                                                          |
| MultilineText   | Renders the value in a `<textarea>` element                                                      |
| Password        | Displays the data so that individual characters are masked from view                             |
| Url             | Displays the data as a URL (using an HTML `<a>` element)                                         |
| EmailAddress    | Displays the data as an e-mail address (using an `<a>` element with a `mailto:` href)            |

The Built-In MVC Framework View Templates

| Value           | Effect (Editor)                                                                                                                                       | Effect (Display)                                                                                         |
|-----------------|-------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------|
| Boolean         | Renders a checkbox for bool values. For nullable `bool?` values, a select element is created with options for True, False, and Not Set.               | As for the editor helpers, but with the addition of the disabled attribute, which renders read-only HTML controls |
| Collection      | Renders the appropriate template for each of the elements in an `IEnumerable` sequence. The items in the sequence do not have to be of the same type. | As for the editor helper                                                                                  |
| Decimal         | Renders a single-line textbox input element and formats the data value to display two decimal places                                                  | Renders the data value formatted to two decimal places                                                    |
| DateTime        | Renders an input element whose `type` attribute is `datetime` and which contains the complete date and time                                           | Renders the complete value of a DateTime variable                                                         |
| Date            | Renders an input element whose `type` attribute is `date` and that contains the date component (but not the time)                                     | Renders the date component of a DateTime variable                                                         |
| EmailAddress    | Renders the value in a single-line textbox input element                                                                                              | Renders a link using an HTML `<a>` element and an `href` attribute that is formatted as a `mailto` URL     |
| HiddenInput     | Creates a hidden input element                                                                                                                        | Renders the data value and creates a hidden input element                                                 |
| Html            | Renders the value in a single-line textbox input element                                                                                              | Renders a link using an HTML `<a>` element                                                                |
| MultilineText   | Renders an HTML `<textarea>` element that contains the data value                                                                                     | Renders the data value                                                                                    |
| Number          | Renders an input element whose `type` attribute is set to `number`                                                                                    | See explanation after this table                                                                          |
| Object          | See explanation after this table                                                                                                                     | See explanation after this table                                                                          |
| Password        | Renders the value in a single-line textbox input element so that the characters are not displayed but can be edited                                    | Renders the data value—the characters are not obscured                                                    |
| String          | Renders the value in a single-line textbox input element                                                                                              | Renders the data value                                                                                    |
| Tel             | Renders an input element whose `type` attribute is set to `tel`                                                                                       | Renders the data value                                                                                    |
| Time            | Renders an input element whose `type` attribute is `time` and which contains the time component (but not the date)                                    | Renders the time component of a DateTime variable                                                         |
| Url             | Renders the value in a single-line textbox input element                                                                                              | Renders a link using an HTML `<a>` element. The inner HTML and the `href` attribute are both set to the data value |

### The URL Helper Methods

The URL helper methods are used to generate URLs in ASP.NET MVC applications.


| Description                | Example                                                          | Output                                           |
|----------------------------|------------------------------------------------------------------|--------------------------------------------------|
| Application-relative URL    | `Url.Content("~/Content/Site.css")`                              | `/Content/Site.css`                              |
| Link to named action/controller | `Html.ActionLink("My Link", "Index", "Home")`                | `<a href="/">My Link</a>`                        |
| URL for action              | `Url.Action("GetPeople", "People")`                              | `/People/GetPeople`                              |
| URL using route data        | `Url.RouteUrl(new {controller = "People", action="GetPeople"})`  | `/People/GetPeople`                              |
| Link using route data       | `Html.RouteLink("My Link", new {controller = "People", action="GetPeople"})` | `<a href="/People/GetPeople">My Link</a>`        |
| Link to named route         | `Html.RouteLink("My Link", "FormRoute", new {controller = "People", action="GetPeople"})` | `<a href="/app/forms/People/GetPeople">My Link</a>` |


## Form authentication

Form authentication is a method of authenticating users in ASP.NET applications. It is based on the use of forms to collect user credentials and authenticate them against a user store (such as a database or Active Directory).

### Configuring Form Authentication

To configure form authentication in an ASP.NET application, you need to make changes to the `web.config` file. The following configuration settings are typically used:

```xml

<configuration>
  <system.web>
    <authentication mode="Forms">
      <forms loginUrl="~/Account/Login" timeout="2880" />
    </authentication>
    <authorization>
      <deny users="?" />
    </authorization>
  </system.web>
</configuration>
```

- The `authentication` element specifies the authentication mode as `Forms` and sets the login URL and timeout for the forms authentication.
- The `authorization` element specifies that anonymous users (`?`) are denied access to the application.
- The `loginUrl` attribute specifies the URL of the login page where users will be redirected to authenticate.
- The `timeout` attribute specifies the duration of the authentication cookie in minutes.

### Exigir autenticación en un controlador con el filtro Authorize

```csharp
namespace SportsStore.WebUI.Controllers {
    // Con el filtro Authorize, se requiere autenticación para acceder a los métodos del controlador
    [Authorize]
    public class AdminController : Controller {
        private IProductRepository repository;
        public AdminController(IProductRepository repo) {
            repository = repo;
        }
        // ...action methods omitted for brevity... }
}
```
